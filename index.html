<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balnearios de Mina Clavero (Carga Autom√°tica)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp,container-queries"></script>
    <style>
        /* Set height for map container */
        #map { height: 100vh; }
        /* Custom styles for list items */
        .destination-item {
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border-left: 3px solid transparent;
        }
        .destination-item:hover {
            background-color: #e5e7eb; /* gray-200 */
            border-left-color: #3b82f6; /* blue-500 */
            transform: translateX(4px);
        }
        /* Categor√≠a items styles */
        .category-title {
            font-weight: 700;
            font-size: 0.95rem;
            margin-top: 0.5rem;
            margin-bottom: 0;
            padding: 0.75rem 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            background: #f9fafb;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
            list-style: none !important;
        }
        .category-title:hover {
            background: #f3f4f6;
        }
        .category-icon {
            font-size: 1.25rem;
        }
        .category-balneario .category-icon { color: #0ea5e9; }
        .category-restobar .category-icon { color: #f59e0b; }
        .category-servicio .category-icon { color: #09ed0c; }
        .category-toggle {
            margin-left: auto;
            font-size: 1rem;
            transition: transform 0.3s ease;
        }
        .category-title.collapsed .category-toggle {
            transform: rotate(-90deg);
        }
        .category-items {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        .category-items.collapsed {
            max-height: 0;
            opacity: 0;
        }
        .destination-item {
            list-style: none !important;
        }
        .destination-item.balneario {
            border-left-color: #0ea5e9;
        }
        .destination-item.restobar {
            border-left-color: #f59e0b;
        }
        .destination-item.servicio {
            border-left-color: #09ed0c;
        }
        /* Ensure Leaflet attribution is visible and readable */
        .leaflet-control-attribution {
            font-size: 10px;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            padding: 2px 5px;
            border-radius: 3px;
        }
        /* Custom marker styles */
        .custom-marker {
            background-size: 100%;
            width: 32px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .marker-balneario {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 30"><path d="M12 1c-6 0-11 5-11 11 0 8 11 18 11 18s11-10 11-18c0-6-5-11-11-11z" fill="%230ea5e9" stroke="%23075985" stroke-width="0.5"/></svg>');
        }
        .marker-restobar {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 30"><path d="M12 1c-6 0-11 5-11 11 0 8 11 18 11 18s11-10 11-18c0-6-5-11-11-11z" fill="%23f59e0b" stroke="%23b45309" stroke-width="0.5"/></svg>');
        }
        .marker-servicio {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 30"><path d="M12 1c-6 0-11 5-11 11 0 8 11 18 11 18s11-10 11-18c0-6-5-11-11-11z" fill="%2309ed0c" stroke="%23065f46" stroke-width="0.5"/></svg>');
        }
         /* Ensure layout takes full viewport height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        .main-container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 30%;
            max-width: 350px;
            overflow-y: scroll;
            border-right: 1px solid #d1d5db; /* gray-300 */
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }
        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            text-align: center;
            flex-grow: 1;
        }
        .close-sidebar-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
        }
        .close-sidebar-btn:hover {
            color: #1f2937;
        }
        .sidebar-content {
             padding: 1rem; /* p-4 */
             padding-right: 0.5rem;
             flex-grow: 1; /* Allow list to take available space */
             overflow-y: scroll; /* Scroll list if needed */
             position: relative;
        }
        /* Estilizar barra de desplazamiento para navegadores webkit */
        .sidebar-content::-webkit-scrollbar {
            width: 20px !important;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: #3b82f6 !important;
            border-radius: 8px;
            border: 3px solid #f1f5f9;
            min-height: 40px;
        }
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #2563eb !important;
        }
        /* Para Firefox */
        .sidebar-content {
            scrollbar-width: thick;
            scrollbar-color: #3b82f6 #f1f5f9;
        }
        /* Indicador visual de scroll en m√≥viles */
        @media (max-width: 768px) {
            .sidebar-content {
                background: linear-gradient(to bottom, #ffffff, #ffffff) content-box padding-box,
                            linear-gradient(to bottom, rgba(0,0,0,0.1), transparent) padding-box;
                background-clip: padding-box, padding-box;
                padding-bottom: 1.5rem;
            }
            .sidebar-content::after {
                content: '';
                display: block;
                height: 0.25rem;
                background: linear-gradient(to right, #3b82f6, #8b5cf6, #3b82f6);
                border-radius: 2px;
                margin-top: 0.5rem;
                opacity: 0.6;
            }
        }
        .map-container {
            flex-grow: 1;
            position: relative;
        }
        .menu-toggle-btn {
            display: none;
            position: absolute;
            top: 60%;
            left: 1rem;
            transform: translateY(-60%);
            z-index: 1000;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 1.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .menu-toggle-btn:hover {
            background: #f3f4f6;
        }
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-width: 100%;
                position: absolute;
                height: auto;
                max-height: 60vh;
                top: 0;
                left: 0;
                z-index: 999;
                border-right: none;
                border-bottom: 1px solid #d1d5db;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateY(0);
            }
            .sidebar-content {
                max-height: 50vh;
            }
            .close-sidebar-btn {
                display: block;
            }
            .menu-toggle-btn {
                display: block;
            }
            #map {
                height: calc(100vh - 2rem);
            }
        }
        @media (max-width: 480px) {
            .sidebar-title {
                font-size: 1rem;
            }
            .sidebar-content {
                max-height: 45vh;
            }
            .sidebar-header {
                padding: 1rem 0.75rem;
            }
        }
         /* Tailwind utility classes */
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-md { border-radius: 0.375rem; }
        .p-4 { padding: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .font-semibold { font-weight: 600; }
        .text-lg { font-size: 1.125rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-gray-700 { color: #374151; }
        .text-gray-500 { color: #6b7280; }
        .text-red-600 { color: #dc2626; }
        .bg-white { background-color: #ffffff; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .leaflet-popup-content a {
            color: #2563eb; /* blue-600 */
            text-decoration: underline;
        }
        .leaflet-popup-content a:hover {
            color: #1d4ed8; /* blue-700 */
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

<div class="main-container">
    <div class="sidebar bg-white" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title"> üó∫Ô∏è Mina Clavero y alrededores</h2>
            <button class="close-sidebar-btn" id="closeSidebarBtn">‚úï</button>
        </div>
        <div class="sidebar-content">
            <ul id="destination-list"></ul>
            <div id="error-message" class="mt-4 text-red-600 text-sm"></div>
            <div id="status-message" class="mt-4 text-gray-500 text-sm"></div>
        </div>
    </div>

    <div id="map" class="map-container">
        <button class="menu-toggle-btn" id="menuToggleBtn">‚ò∞</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    let map; // Declare map globally
    let markersLayer = L.featureGroup(); // Use FeatureGroup to enable getBounds()
    const listElement = document.getElementById('destination-list');
    const errorDiv = document.getElementById('error-message');
    const statusDiv = document.getElementById('status-message');
    const sidebar = document.getElementById('sidebar');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');

    // Mobile menu toggle functionality
    menuToggleBtn.addEventListener('click', () => {
        sidebar.classList.add('open');
    });

    closeSidebarBtn.addEventListener('click', () => {
        sidebar.classList.remove('open');
    });

    // Close sidebar when clicking on a destination
    listElement.addEventListener('click', (e) => {
        if (e.target.classList.contains('destination-item')) {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
        }
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && !sidebar.contains(e.target) && e.target !== menuToggleBtn) {
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        }
    });

    // Indicador visual de scroll en la barra lateral
    const sidebarContent = document.querySelector('.sidebar-content');
    if (sidebarContent) {
        sidebarContent.addEventListener('scroll', () => {
            const scrollTop = sidebarContent.scrollTop;
            const scrollHeight = sidebarContent.scrollHeight;
            const clientHeight = sidebarContent.clientHeight;
            
            // Si hay scroll disponible, mostrar indicador
            if (scrollHeight > clientHeight) {
                if (scrollTop > 0) {
                    sidebarContent.style.borderTop = '3px solid #3b82f6';
                } else {
                    sidebarContent.style.borderTop = 'none';
                }
                
                // Indicador en la parte inferior si no est√° al final
                if (scrollTop + clientHeight < scrollHeight - 10) {
                    sidebarContent.style.borderBottom = '3px solid #3b82f6';
                } else {
                    sidebarContent.style.borderBottom = 'none';
                }
            }
        });
        
        // Activar indicador inicial si es necesario
        sidebarContent.dispatchEvent(new Event('scroll'));
    }

    // Function to clear existing map data (markers and list)
    function clearMapData() {
        markersLayer.clearLayers();
        if(listElement) listElement.innerHTML = '';
        if(errorDiv) errorDiv.textContent = '';
        if(statusDiv) statusDiv.textContent = '';
    }

    // Function to parse CSV text and display data on map
    function loadAndDisplayData(csvText) {
        const locations = [];
        const lines = csvText.trim().split('\n');

        // Parse data (skip header row)
        for (let i = 0; i < lines.length; i++) {
            if (i === 0 && lines[i].toLowerCase().includes('provincia')) continue;
            const parts = lines[i].split(',');
            if (parts.length >= 6) {
                const province = parts[0].trim();
                const city = parts[1].trim();
                const lat = parseFloat(parts[2]);
                const lon = parseFloat(parts[3]);
                const link = parts[4].trim();
                const tipo = parts[5].trim().toLowerCase();

                if (!isNaN(lat) && !isNaN(lon) && city && province && tipo) {
                    locations.push({ 
                        name: `${city}, ${province}`, 
                        coords: [lat, lon], 
                        link: link,
                        tipo: tipo 
                    });
                } else {
                    console.warn(`Skipping invalid row ${i + 1}: ${lines[i]}`);
                }
            } else {
                 if (lines[i].trim().length > 0 && lines[i].split(',').length > 1) {
                    console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
                 }
            }
        }

        if (locations.length === 0) {
             console.warn("No valid locations found in the provided data.");
             if(errorDiv) errorDiv.textContent = 'No se encontraron ubicaciones v√°lidas en los datos del archivo.';
             return;
        }

        // --- Populate List and Add Markers by Category ---
        if (!listElement) {
            throw new Error("Sidebar list element ('destination-list') not found.");
        }

        // Agrupar por tipo
        const categorized = {
            balneario: [],
            restobar: [],
            servicio: []
        };

        locations.forEach(loc => {
            if (categorized[loc.tipo]) {
                categorized[loc.tipo].push(loc);
            }
        });

        // Crear t√≠tulos y items por categor√≠a
        const categoryInfo = [
            { key: 'balneario', title: 'Balnearios', icon: 'üèñÔ∏è' },
            { key: 'restobar', title: 'Bares-Restaurantes', icon: 'üçΩÔ∏è' },
            { key: 'servicio', title: 'Servicios', icon: 'üè¢' }
        ];

        categoryInfo.forEach(cat => {
            if (categorized[cat.key].length > 0) {
                // Agregar t√≠tulo de categor√≠a
                const categoryHeader = document.createElement('li');
                categoryHeader.className = `category-title category-${cat.key} collapsed`;
                categoryHeader.innerHTML = `<span class="category-icon">${cat.icon}</span> ${cat.title} (${categorized[cat.key].length}) <span class="category-toggle">‚ñº</span>`;
                listElement.appendChild(categoryHeader);

                // Crear contenedor para los items de la categor√≠a
                const categoryContainer = document.createElement('div');
                categoryContainer.className = `category-items collapsed`;
                categoryContainer.setAttribute('data-category', cat.key);

                // Agregar items de la categor√≠a
                categorized[cat.key].forEach(loc => {
                    const listItem = document.createElement('li');
                    listItem.textContent = loc.name;
                    listItem.className = `p-2 mb-2 rounded-md destination-item ${loc.tipo} text-sm text-gray-700`;
                    listItem.onclick = () => { map.flyTo(loc.coords, 18); };
                    categoryContainer.appendChild(listItem);

                    // Create map marker with color based on type
                    const markerIconClass = `marker-${loc.tipo}`;
                    const customIcon = L.divIcon({
                        className: `custom-marker ${markerIconClass}`,
                        iconSize: [32, 40],
                        iconAnchor: [16, 40],
                        popupAnchor: [0, -40]
                    });

                    const marker = L.marker(loc.coords, { 
                        pane: 'markerPane',
                        title: loc.name,
                        icon: customIcon
                    });
                    const popupContent = `<b>${loc.name}</b><br><strong>Tipo:</strong> ${loc.tipo}<br><b>${loc.link}</b><br><a href="https://www.google.com/maps/dir/La+Br%C3%BAjula+Hostel+y+Club+Social/${loc.coords}/@-31.7272354,-65.0056258,1241m/data=!3m1!1e3!4m9!4m8!1m5!1m1!1s0x942d27ab14f282c9:0xc7e876d27bc68a47!2m2!1d-65.0127905!2d-31.7248017!1m0!3e0?entry=ttu&g_ep=EgoyMDI2MDExMy4wIKXMDSoASAFQAw%3D%3D" target="_blank" rel="noopener noreferrer">Como llegar</a>`;
                    marker.bindPopup(popupContent);
                    markersLayer.addLayer(marker);
                });

                // Agregar el contenedor al listElement
                listElement.appendChild(categoryContainer);

                // Event listener para expandir/colapsar
                categoryHeader.addEventListener('click', () => {
                    // Cerrar todas las otras categor√≠as
                    document.querySelectorAll('.category-items').forEach(item => {
                        if (item !== categoryContainer) {
                            item.classList.add('collapsed');
                        }
                    });
                    document.querySelectorAll('.category-title').forEach(title => {
                        if (title !== categoryHeader) {
                            title.classList.add('collapsed');
                        }
                    });

                    // Alternar la categor√≠a actual
                    categoryContainer.classList.toggle('collapsed');
                    categoryHeader.classList.toggle('collapsed');
                });
            }
        });

        // Adjust map bounds to fit all markers
        if (markersLayer.getLayers().length > 0) {
            map.fitBounds(markersLayer.getBounds().pad(0.1));
            if(statusDiv) statusDiv.textContent = `Se cargaron ${locations.length} ubicaciones desde el archivo.`;
        }
    }

    // --- Initialization ---
    try {
        if (typeof L === 'undefined') {
            throw new Error("Leaflet library (L) not loaded correctly.");
        }

        // Initialize the map
        map = L.map('map').setView([-38.416, -63.616], 5); // Centered on Argentina

        // Add IGN WMS Layer (Base)
        //const ignWmsUrl = 'https://wms.ign.gob.ar/geoserver/wms?';
        //const ignLayerName = 'departamentos,rios,ciudades,limites_provinciales,limites_nacionales,carreteras';
        //const ignWmsLayer = L.tileLayer.wms(ignWmsUrl, {
        //    layers: ignLayerName,
        //    format: 'image/png',
        //    transparent: false,
        //    version: '1.3.0',
        //    attribution: '&copy; <a href="https://www.ign.gob.ar/">IGN Argentina</a>'
        //}).addTo(map);
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Add ESRI Satellite Layer (Overlay, Semi-Transparent)
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 90,
            attribution: 'Tiles &copy; Esri',
        }); // NO .addTo(map) - don't add it by default

        // Create layer control to toggle between views
        const baseLayers = {
            'Mapa (con calles)': osmLayer,
            'Sat√©lite': satelliteLayer
        };
        L.control.layers(baseLayers).addTo(map);

        // Add the markers layer group to the map
        markersLayer.addTo(map);

        // Ensure map panes exist (markerPane is needed for markers)
        map.createPane('markerPane');
        map.getPane('markerPane').style.zIndex = 650; // Ensure markers are above all tile layers

        // --- REMOVED File Input Event Listener ---

        // --- ADDED: Fetch CSV data automatically ---
        const csvFilePath = './balnearios_mina_clavero.csv'; // Relative path to your CSV file
                                                   // Make sure the filename is correct!

        if(statusDiv) statusDiv.textContent = 'Cargando datos desde archivo...';

        fetch(csvFilePath)
            .then(response => {
                if (!response.ok) {
                    // Handle HTTP errors (like file not found - 404)
                    throw new Error(`Error al cargar el archivo: ${response.status} ${response.statusText}`);
                }
                return response.text(); // Get the file content as text
            })
            .then(csvText => {
                // File loaded successfully, process it
                clearMapData(); // Clear any previous data (though unlikely needed on initial load)
                loadAndDisplayData(csvText); // Process the new data
                console.log("CSV data loaded and processed successfully via fetch.");
            })
            .catch(fetchError => {
                // Handle errors during fetch (network error, file not found, etc.)
                console.error('Error fetching CSV file:', fetchError);
                if(errorDiv) errorDiv.textContent = `No se pudo cargar el archivo '${csvFilePath}'. Verifica que el archivo exista en la misma carpeta y que est√©s usando un servidor web. Error: ${fetchError.message}`;
                if(statusDiv) statusDiv.textContent = ''; // Clear loading message
            });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (map) {
                 map.invalidateSize();
            }
        });

        console.log("Map initialized. Attempting to fetch CSV data...");

    } catch (error) {
        // --- Error Handling for Initialization ---
        console.error("Error initializing map:", error);
        if (errorDiv) {
            errorDiv.textContent = `Ocurri√≥ un error al inicializar el mapa: ${error.message}.`;
        }
    }
</script>

</body>
</html>
